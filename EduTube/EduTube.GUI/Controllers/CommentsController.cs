using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using EduTube.DAL.Data;
using EduTube.DAL.Entities;
using EduTube.BLL.Managers.Interfaces;
using EduTube.GUI.ViewModels;
using EduTube.BLL.Models;
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;

namespace EduTube.GUI.Controllers
{
   public class CommentsController : Controller
   {
      private readonly ICommentManager _commentManager;
      private readonly IApplicationUserManager _userManager;

      public CommentsController(ICommentManager commentManager, IApplicationUserManager userManager)
      {
         _commentManager = commentManager;
         _userManager = userManager;
      }

      public async Task<IActionResult> GetByVideo(int videoId, int lastCommentId)
      {
         return Json(await _commentManager.GetByVideo(videoId, lastCommentId));
      }

      // POST: Comments/Create
      // To protect from overposting attacks, please enable the specific properties you want to bind to, for 
      // more details see http://go.microsoft.com/fwlink/?LinkId=317598.
      [Authorize]
      [HttpPost]
      public async Task<IActionResult> Create(CreateCommentViewModel viewModel)
      {
         if (ModelState.IsValid)
         {
            ApplicationUserModel user = await _userManager.GetById(User.FindFirstValue(ClaimTypes.NameIdentifier), false);

            if (user.Blocked)
            {
               await _userManager.Logout();
               return StatusCode(403);
            }

            CommentModel comment = new CommentModel()
            {
               Content = viewModel.CommentContent,
               DateCreatedOn = DateTime.Now,
               Deleted = false,
               VideoId = viewModel.VideoId,
               UserId = user.Id
            };
            comment = await _commentManager.Create(comment);
            return Json(new { commentId = comment.Id, ownerProfileImage = user.ProfileImage, ownerChannelName = user.ChannelName,
               dateCreatedOn = comment.DateCreatedOn, commentContent = comment.Content});
         }
         return StatusCode(400);
      }

      [Authorize]
      [HttpPut]
      [Route("Comments/Edit/{id}")]
      public async Task<IActionResult> Edit(int id, CreateCommentViewModel viewModel)
      {
         string userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
         CommentModel comment = await _commentManager.GetById(id, false);

         if (!userId.Equals(comment.UserId))
            return StatusCode(400);

         await _commentManager.Update(id, viewModel.CommentContent);

         return StatusCode(200);
      }

      public IActionResult GetDeleteDialog(int id)
      {
         ViewData["type"] = "comment";
         ViewData["id"] = id;
         return PartialView("DeleteModalDialog");
      }

      [Authorize]
      [HttpDelete]
      [Route("Comments/Delete/{id}")]
      public async Task<IActionResult> Delete(int id)
      {
         int result = await _commentManager.Remove(id);
         if (result > 0 )
            return StatusCode(200);
         else
            return StatusCode(404);
      }

   }
}
